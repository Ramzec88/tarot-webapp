<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîÆ –¢–µ—Å—Ç Google Sheets</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: #fff;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
        }
        .logo {
            font-size: 32px;
            margin-bottom: 20px;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }
        .test-title {
            color: #ffd700;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
        }
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            margin: 5px;
            transition: transform 0.2s;
            width: 100%;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .result {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        .success { color: #4ade80; }
        .error { color: #ef4444; }
        .info { color: #60a5fa; }
        .warning { color: #fbbf24; }
        .user-info {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            display: none;
        }
        .subscription-status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        .subscription-status.premium {
            background: linear-gradient(45deg, #ffd700, #ffed4a);
            color: #1a1a2e;
        }
        .subscription-status.free {
            background: rgba(255, 255, 255, 0.1);
            color: #b0b0b0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">‚ú® –¢–µ—Å—Ç Google Sheets ‚ú®</div>
        
        <div class="test-section">
            <div class="test-title">üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
            
            <div class="form-group">
                <label for="user-id">Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <input type="text" id="user-id" placeholder="–í–≤–µ–¥–∏—Ç–µ Telegram ID" value="12345">
            </div>
            
            <div class="form-group">
                <label for="test-type">–¢–∏–ø —Ç–µ—Å—Ç–∞:</label>
                <select id="test-type">
                    <option value="check_user">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>
                    <option value="send_message">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –±–æ—Ç–∞</option>
                    <option value="full_flow">–ü–æ–ª–Ω—ã–π —Ñ–ª–æ—É</option>
                </select>
            </div>
            
            <button class="btn" onclick="runTest()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
            <button class="btn" onclick="testCurrentUser()">üë§ –¢–µ—Å—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
        </div>
        
        <div class="user-info" id="user-info">
            <h4>üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h4>
            <div id="user-details"></div>
        </div>
        
        <div class="test-section">
            <div class="test-title">üì± –¢–µ—Å—Ç —á–µ—Ä–µ–∑ –æ—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç</div>
            <p style="color: #b0b0b0; font-size: 14px;">
                –≠—Ç–æ—Ç —Ç–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –≤–∞—à –æ—Å–Ω–æ–≤–Ω–æ–π workflow "–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –®–µ–ø–æ—Ç –∫–∞—Ä—Ç-2"
            </p>
            
            <div class="form-group">
                <label for="bot-message">–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –±–æ—Ç–∞:</label>
                <input type="text" id="bot-message" placeholder="–ö–∞—Ä—Ç–∞ –¥–Ω—è" value="–ö–∞—Ä—Ç–∞ –¥–Ω—è">
            </div>
            
            <button class="btn" onclick="testMainBot()">ü§ñ –¢–µ—Å—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–æ—Ç–∞</button>
        </div>
        
        <div class="result" id="result">
            <h4>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤:</h4>
            <div id="result-content"></div>
        </div>
    </div>

    <script>
        let tg;
        let currentUser = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('DOMContentLoaded', function() {
            initTelegram();
            log('üöÄ –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'info');
        });
        
        function initTelegram() {
            if (window.Telegram && window.Telegram.WebApp) {
                tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                
                const user = tg.initDataUnsafe?.user;
                if (user) {
                    currentUser = user;
                    document.getElementById('user-id').value = user.id;
                    log(`üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram: ${user.first_name} (ID: ${user.id})`, 'success');
                } else {
                    currentUser = {id: 12345, first_name: 'Test User'};
                    log('üîß –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º (–±–µ–∑ Telegram)', 'info');
                }
            } else {
                currentUser = {id: 12345, first_name: 'Test User'};
                log('‚ö†Ô∏è Telegram WebApp –Ω–µ –Ω–∞–π–¥–µ–Ω, —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º', 'warning');
            }
        }

        async function runTest() {
            const userId = document.getElementById('user-id').value.trim();
            const testType = document.getElementById('test-type').value;
            
            if (!userId) {
                log('‚ùå –í–≤–µ–¥–∏—Ç–µ Telegram ID', 'error');
                return;
            }
            
            log(`üîç –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞: ${testType} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}`, 'info');
            
            switch(testType) {
                case 'check_user':
                    await checkUserInSheets(userId);
                    break;
                case 'send_message':
                    await sendMessageToBot(userId);
                    break;
                case 'full_flow':
                    await runFullFlow(userId);
                    break;
            }
        }

        async function checkUserInSheets(userId) {
            log('üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Google Sheets...', 'info');
            
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º webhook –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ workflow
                const response = await fetch('https://romanmedn8n.ru/webhook/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: {
                            from: { id: userId },
                            chat: { id: userId },
                            text: '/check'
                        }
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –∏–∑ Google Sheets:', 'success');
                    log(JSON.stringify(result, null, 2), 'info');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                    displayUserInfo(result);
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ HTTP: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
            }
        }

        async function sendMessageToBot(userId) {
            const message = document.getElementById('bot-message').value.trim();
            
            log(`üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –±–æ—Ç–∞: "${message}"`, 'info');
            
            try {
                const response = await fetch('https://romanmedn8n.ru/webhook/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: {
                            from: { 
                                id: parseInt(userId),
                                first_name: currentUser?.first_name || 'Test User',
                                username: currentUser?.username || 'test_user'
                            },
                            chat: { id: parseInt(userId) },
                            text: message
                        }
                    })
                });

                if (response.ok) {
                    const result = await response.text();
                    log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –±–æ—Ç–æ–º:', 'success');
                    log(result, 'info');
                } else {
                    log(`‚ùå –û—à–∏–±–∫–∞ –±–æ—Ç–∞: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${error.message}`, 'error');
            }
        }

        async function runFullFlow(userId) {
            log('üîÑ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ñ–ª–æ—É...', 'info');
            
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await checkUserInSheets(userId);
            
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É /start
            log('2Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º /start...', 'info');
            await sendMessageToBot(userId, '/start');
            
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // 3. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–∞—Ä—Ç—É –¥–Ω—è
            log('3Ô∏è‚É£ –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–∞—Ä—Ç—É –¥–Ω—è...', 'info');
            await sendMessageToBot(userId, '–ö–∞—Ä—Ç–∞ –¥–Ω—è');
            
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // 4. –ó–∞–¥–∞–µ–º –≤–æ–ø—Ä–æ—Å
            log('4Ô∏è‚É£ –ó–∞–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å...', 'info');
            await sendMessageToBot(userId, '–ß—Ç–æ –º–µ–Ω—è –∂–¥–µ—Ç –≤ –±—É–¥—É—â–µ–º?');
            
            log('‚úÖ –ü–æ–ª–Ω—ã–π —Ñ–ª–æ—É –∑–∞–≤–µ—Ä—à–µ–Ω!', 'success');
        }

        async function testCurrentUser() {
            if (!currentUser) {
                log('‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ', 'error');
                return;
            }
            
            document.getElementById('user-id').value = currentUser.id;
            await checkUserInSheets(currentUser.id);
        }

        async function testMainBot() {
            const message = document.getElementById('bot-message').value.trim();
            const userId = document.getElementById('user-id').value.trim();
            
            if (!message || !userId) {
                log('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            await sendMessageToBot(userId, message);
        }

        function displayUserInfo(userData) {
            const userInfo = document.getElementById('user-info');
            const userDetails = document.getElementById('user-details');
            
            if (!userData) {
                userInfo.style.display = 'none';
                return;
            }
            
            // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            let subscriptionStatus = 'free';
            let questionsLeft = 0;
            let subscriptionExpiry = null;
            
            if (userData.user) {
                questionsLeft = userData.user.free_predictions_left || 0;
                subscriptionStatus = userData.user.is_subscribed === 'true' ? 'premium' : 'free';
                subscriptionExpiry = userData.user.subscription_expiry_date;
            }
            
            userDetails.innerHTML = `
                <div class="subscription-status ${subscriptionStatus}">
                    ${subscriptionStatus === 'premium' ? 'üëë –ü–†–ï–ú–ò–£–ú –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨' : 'üÜì –ë–ï–°–ü–õ–ê–¢–ù–ê–Ø –í–ï–†–°–ò–Ø'}
                </div>
                <p><strong>ID:</strong> ${userData.user?.user_id || '–ù–µ –Ω–∞–π–¥–µ–Ω'}</p>
                <p><strong>–û—Å—Ç–∞–ª–æ—Å—å –≤–æ–ø—Ä–æ—Å–æ–≤:</strong> ${questionsLeft}</p>
                <p><strong>–ü–æ–¥–ø–∏—Å–∫–∞ –¥–æ:</strong> ${subscriptionExpiry || '–ù–µ –∞–∫—Ç–∏–≤–Ω–∞'}</p>
                <p><strong>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥:</strong> ${userData.user?.referral_code || '–ù–µ —Å–æ–∑–¥–∞–Ω'}</p>
                <p><strong>–ü—Ä–∏–≥–ª–∞—à–µ–Ω –∫–µ–º:</strong> ${userData.user?.referred_by || '–ù–∏–∫–µ–º'}</p>
            `;
            
            userInfo.style.display = 'block';
            
            log(`üìä –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${subscriptionStatus}, –≤–æ–ø—Ä–æ—Å–æ–≤: ${questionsLeft}`, 'success');
        }

        function log(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            const contentDiv = document.getElementById('result-content');
            
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            contentDiv.appendChild(entry);
            resultDiv.style.display = 'block';
            contentDiv.scrollTop = contentDiv.scrollHeight;
            
            console.log(`${type.toUpperCase()}: ${message}`);
        }
    </script>
</body>
</html>
